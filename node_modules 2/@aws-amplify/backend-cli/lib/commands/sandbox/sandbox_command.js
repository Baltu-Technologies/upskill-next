import fs from 'fs';
import fsp from 'fs/promises';
import { AmplifyPrompter } from '@aws-amplify/cli-core';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, generateEmptyClientConfigToFile, getClientConfigFileName, getClientConfigPath, } from '@aws-amplify/client-config';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxIdentifier;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe = 'Starts sandbox, watch mode for amplify deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxIdentifier = args.identifier;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args.configVersion, args.configOutDir, args.configFormat);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxIdentifier: this.sandboxIdentifier,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const fileName = getClientConfigFileName(args.configVersion);
        const clientConfigWritePath = await getClientConfigPath(fileName, args.configOutDir, args.configFormat);
        if (!fs.existsSync(clientConfigWritePath)) {
            await generateEmptyClientConfigToFile(args.configVersion, args.configOutDir, args.configFormat);
        }
        watchExclusions.push(clientConfigWritePath);
        await sandbox.start({
            dir: args.dirToWatch,
            exclude: watchExclusions,
            identifier: args.identifier,
            profile: args.profile,
            watchForChanges: !args.once,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. Defaults to the amplify directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('identifier', {
            describe: 'An optional identifier to distinguish between different sandboxes. Default is the name of the system user executing the process',
            type: 'string',
            array: false,
        })
            .option('config-format', {
            describe: 'Client config output format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('config-version', {
            describe: 'Client config format version',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            global: false,
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('config-out-dir', {
            describe: 'A path to directory where config is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .option('once', {
            describe: 'Execute a single sandbox deployment without watching for future file changes',
            boolean: true,
            global: false,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv.identifier) {
                const identifierRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.identifier.match(identifierRegex)) {
                    throw new Error(`--identifier should match [a-zA-Z0-9-] and be less than 15 characters.`);
                }
            }
            return true;
        })
            .conflicts('once', ['exclude', 'dir-to-watch'])
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion]));
    };
    sigIntHandler = async () => {
        const answer = await AmplifyPrompter.yesOrNo({
            message: 'Would you like to delete all the resources in your sandbox environment (This cannot be undone)?',
            defaultValue: false,
        });
        if (answer)
            await (await this.sandboxFactory.getInstance()).delete({ identifier: this.sandboxIdentifier });
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`);
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXhELE9BQU8sRUFDTCxrQkFBa0IsRUFFbEIseUJBQXlCLEVBQ3pCLDZCQUE2QixFQUM3QiwrQkFBK0IsRUFDL0IsdUJBQXVCLEVBQ3ZCLG1CQUFtQixHQUNwQixNQUFNLDRCQUE0QixDQUFDO0FBQ3BDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLHdEQUF3RCxDQUFDO0FBa0N0Rzs7R0FFRztBQUNILE1BQU0sT0FBTyxjQUFjO0lBbUJOO0lBQ0E7SUFDVDtJQUNBO0lBQ1M7SUFwQm5COztPQUVHO0lBQ00sT0FBTyxDQUFTO0lBRXpCOztPQUVHO0lBQ00sUUFBUSxDQUFTO0lBRWxCLGlCQUFpQixDQUFVO0lBRW5DOztPQUVHO0lBQ0gsWUFDbUIsY0FBdUMsRUFDdkMsa0JBQW1DLEVBQzVDLDRCQUEwRCxFQUMxRCxpQkFBb0MsRUFDM0IsMEJBQXVEO1FBSnZELG1CQUFjLEdBQWQsY0FBYyxDQUF5QjtRQUN2Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQWlCO1FBQzVDLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBOEI7UUFDMUQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUMzQiwrQkFBMEIsR0FBMUIsMEJBQTBCLENBQTZCO1FBRXhFLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxRQUFRLEdBQUcsb0RBQW9ELENBQUM7SUFDdkUsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTyxHQUFHLEtBQUssRUFDYixJQUF3RCxF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QUEyQixDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFyZ3VtZW50c0NhbWVsQ2FzZSwgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZnNwIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IEFtcGxpZnlQcm9tcHRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQgeyBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9zYW5kYm94JztcbmltcG9ydCB7XG4gIENsaWVudENvbmZpZ0Zvcm1hdCxcbiAgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgQ2xpZW50Q29uZmlnVmVyc2lvbk9wdGlvbixcbiAgREVGQVVMVF9DTElFTlRfQ09ORklHX1ZFUlNJT04sXG4gIGdlbmVyYXRlRW1wdHlDbGllbnRDb25maWdUb0ZpbGUsXG4gIGdldENsaWVudENvbmZpZ0ZpbGVOYW1lLFxuICBnZXRDbGllbnRDb25maWdQYXRoLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpZW50LWNvbmZpZyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyIH0gZnJvbSAnLi4vLi4vY2xpZW50LWNvbmZpZy9jbGllbnRfY29uZmlnX2xpZmVjeWNsZV9oYW5kbGVyLmpzJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXIgfSBmcm9tICcuLi8uLi9jbGllbnQtY29uZmlnL2NsaWVudF9jb25maWdfZ2VuZXJhdG9yX2FkYXB0ZXIuanMnO1xuaW1wb3J0IHsgQ29tbWFuZE1pZGRsZXdhcmUgfSBmcm9tICcuLi8uLi9jb21tYW5kX21pZGRsZXdhcmUuanMnO1xuaW1wb3J0IHsgU2FuZGJveENvbW1hbmRHbG9iYWxPcHRpb25zIH0gZnJvbSAnLi9vcHRpb25fdHlwZXMuanMnO1xuaW1wb3J0IHsgQXJndW1lbnRzS2ViYWJDYXNlIH0gZnJvbSAnLi4vLi4va2ViYWJfY2FzZS5qcyc7XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZSA9IEFyZ3VtZW50c0tlYmFiQ2FzZTxcbiAge1xuICAgIGRpclRvV2F0Y2g6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBleGNsdWRlOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgICBjb25maWdGb3JtYXQ6IENsaWVudENvbmZpZ0Zvcm1hdCB8IHVuZGVmaW5lZDtcbiAgICBjb25maWdPdXREaXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBjb25maWdWZXJzaW9uOiBzdHJpbmc7XG4gICAgb25jZTogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgfSAmIFNhbmRib3hDb21tYW5kR2xvYmFsT3B0aW9uc1xuPjtcblxuZXhwb3J0IHR5cGUgRXZlbnRIYW5kbGVyID0gKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlcnMgPSB7XG4gIHN1Y2Nlc3NmdWxEZXBsb3ltZW50OiBFdmVudEhhbmRsZXJbXTtcbiAgc3VjY2Vzc2Z1bERlbGV0aW9uOiBFdmVudEhhbmRsZXJbXTtcbiAgZmFpbGVkRGVwbG95bWVudDogRXZlbnRIYW5kbGVyW107XG59O1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVyUGFyYW1zID0ge1xuICBzYW5kYm94SWRlbnRpZmllcj86IHN0cmluZztcbiAgY2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjogQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yID0gKFxuICBwYXJhbXM6IFNhbmRib3hFdmVudEhhbmRsZXJQYXJhbXNcbikgPT4gU2FuZGJveEV2ZW50SGFuZGxlcnM7XG5cbi8qKlxuICogQ29tbWFuZCB0aGF0IHN0YXJ0cyBzYW5kYm94LlxuICovXG5leHBvcnQgY2xhc3MgU2FuZGJveENvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgU2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBzYW5kYm94SWRlbnRpZmllcj86IHN0cmluZztcblxuICAvKipcbiAgICogQ3JlYXRlcyBzYW5kYm94IGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hGYWN0b3J5OiBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hTdWJDb21tYW5kczogQ29tbWFuZE1vZHVsZVtdLFxuICAgIHByaXZhdGUgY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcjogQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICBwcml2YXRlIGNvbW1hbmRNaWRkbGV3YXJlOiBDb21tYW5kTWlkZGxld2FyZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPzogU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3JcbiAgKSB7XG4gICAgdGhpcy5jb21tYW5kID0gJ3NhbmRib3gnO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnU3RhcnRzIHNhbmRib3gsIHdhdGNoIG1vZGUgZm9yIGFtcGxpZnkgZGVwbG95bWVudHMnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBoYW5kbGVyID0gYXN5bmMgKFxuICAgIGFyZ3M6IEFyZ3VtZW50c0NhbWVsQ2FzZTxTYW5kYm94Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2U+XG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHNhbmRib3ggPSBhd2FpdCB0aGlzLnNhbmRib3hGYWN0b3J5LmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5zYW5kYm94SWRlbnRpZmllciA9IGFyZ3MuaWRlbnRpZmllcjtcblxuICAgIC8vIGF0dGFjaGluZyBldmVudCBoYW5kbGVyc1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgPSBuZXcgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcihcbiAgICAgIHRoaXMuY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICAgIGFyZ3MuY29uZmlnVmVyc2lvbiBhcyBDbGllbnRDb25maWdWZXJzaW9uLFxuICAgICAgYXJncy5jb25maWdPdXREaXIsXG4gICAgICBhcmdzLmNvbmZpZ0Zvcm1hdFxuICAgICk7XG4gICAgY29uc3QgZXZlbnRIYW5kbGVycyA9IHRoaXMuc2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3I/Lih7XG4gICAgICBzYW5kYm94SWRlbnRpZmllcjogdGhpcy5zYW5kYm94SWRlbnRpZmllcixcbiAgICAgIGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIsXG4gICAgfSk7XG4gICAgaWYgKGV2ZW50SGFuZGxlcnMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKGV2ZW50SGFuZGxlcnMpLmZvckVhY2goKFtldmVudCwgaGFuZGxlcnNdKSA9PiB7XG4gICAgICAgIGhhbmRsZXJzLmZvckVhY2goKGhhbmRsZXIpID0+IHNhbmRib3gub24oZXZlbnQsIGhhbmRsZXIpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB3YXRjaEV4Y2x1c2lvbnMgPSBhcmdzLmV4Y2x1ZGUgPz8gW107XG4gICAgY29uc3QgZmlsZU5hbWUgPSBnZXRDbGllbnRDb25maWdGaWxlTmFtZShcbiAgICAgIGFyZ3MuY29uZmlnVmVyc2lvbiBhcyBDbGllbnRDb25maWdWZXJzaW9uXG4gICAgKTtcbiAgICBjb25zdCBjbGllbnRDb25maWdXcml0ZVBhdGggPSBhd2FpdCBnZXRDbGllbnRDb25maWdQYXRoKFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBhcmdzLmNvbmZpZ091dERpcixcbiAgICAgIGFyZ3MuY29uZmlnRm9ybWF0XG4gICAgKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhjbGllbnRDb25maWdXcml0ZVBhdGgpKSB7XG4gICAgICBhd2FpdCBnZW5lcmF0ZUVtcHR5Q2xpZW50Q29uZmlnVG9GaWxlKFxuICAgICAgICBhcmdzLmNvbmZpZ1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICAgICAgYXJncy5jb25maWdPdXREaXIsXG4gICAgICAgIGFyZ3MuY29uZmlnRm9ybWF0XG4gICAgICApO1xuICAgIH1cblxuICAgIHdhdGNoRXhjbHVzaW9ucy5wdXNoKGNsaWVudENvbmZpZ1dyaXRlUGF0aCk7XG4gICAgYXdhaXQgc2FuZGJveC5zdGFydCh7XG4gICAgICBkaXI6IGFyZ3MuZGlyVG9XYXRjaCxcbiAgICAgIGV4Y2x1ZGU6IHdhdGNoRXhjbHVzaW9ucyxcbiAgICAgIGlkZW50aWZpZXI6IGFyZ3MuaWRlbnRpZmllcixcbiAgICAgIHByb2ZpbGU6IGFyZ3MucHJvZmlsZSxcbiAgICAgIHdhdGNoRm9yQ2hhbmdlczogIWFyZ3Mub25jZSxcbiAgICB9KTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR0lOVCcsICgpID0+IHZvaWQgdGhpcy5zaWdJbnRIYW5kbGVyKCkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8U2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPiA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHlhcmdzXG4gICAgICAgIC8vIENhc3QgdG8gZXJhc2Ugb3B0aW9ucyB0eXBlcyB1c2VkIGluIGludGVybmFsIHN1YiBjb21tYW5kIGltcGxlbWVudGF0aW9uLiBPdGhlcndpc2UsIGNvbXBpbGVyIGZhaWxzIGhlcmUuXG4gICAgICAgIC5jb21tYW5kKHRoaXMuc2FuZGJveFN1YkNvbW1hbmRzKVxuICAgICAgICAudmVyc2lvbihmYWxzZSlcbiAgICAgICAgLm9wdGlvbignZGlyLXRvLXdhdGNoJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0RpcmVjdG9yeSB0byB3YXRjaCBmb3IgZmlsZSBjaGFuZ2VzLiBBbGwgc3ViZGlyZWN0b3JpZXMgYW5kIGZpbGVzIHdpbGwgYmUgaW5jbHVkZWQuIERlZmF1bHRzIHRvIHRoZSBhbXBsaWZ5IGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdleGNsdWRlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIGFycmF5IG9mIHBhdGhzIG9yIGdsb2IgcGF0dGVybnMgdG8gaWdub3JlLiBQYXRocyBjYW4gYmUgcmVsYXRpdmUgb3IgYWJzb2x1dGUgYW5kIGNhbiBlaXRoZXIgYmUgZmlsZXMgb3IgZGlyZWN0b3JpZXMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2lkZW50aWZpZXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQW4gb3B0aW9uYWwgaWRlbnRpZmllciB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIGRpZmZlcmVudCBzYW5kYm94ZXMuIERlZmF1bHQgaXMgdGhlIG5hbWUgb2YgdGhlIHN5c3RlbSB1c2VyIGV4ZWN1dGluZyB0aGUgcHJvY2VzcycsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdjb25maWctZm9ybWF0Jywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQ2xpZW50IGNvbmZpZyBvdXRwdXQgZm9ybWF0JyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgY2hvaWNlczogT2JqZWN0LnZhbHVlcyhDbGllbnRDb25maWdGb3JtYXQpLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2NvbmZpZy12ZXJzaW9uJywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQ2xpZW50IGNvbmZpZyBmb3JtYXQgdmVyc2lvbicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnVmVyc2lvbk9wdGlvbiksXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgICBkZWZhdWx0OiBERUZBVUxUX0NMSUVOVF9DT05GSUdfVkVSU0lPTixcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignY29uZmlnLW91dC1kaXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBjb25maWcgaXMgd3JpdHRlbi4gSWYgbm90IHByb3ZpZGVkIGRlZmF1bHRzIHRvIGN1cnJlbnQgcHJvY2VzcyB3b3JraW5nIGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdwcm9maWxlJywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQW4gQVdTIHByb2ZpbGUgbmFtZS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignb25jZScsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdFeGVjdXRlIGEgc2luZ2xlIHNhbmRib3ggZGVwbG95bWVudCB3aXRob3V0IHdhdGNoaW5nIGZvciBmdXR1cmUgZmlsZSBjaGFuZ2VzJyxcbiAgICAgICAgICBib29sZWFuOiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5jaGVjayhhc3luYyAoYXJndikgPT4ge1xuICAgICAgICAgIGlmIChhcmd2WydkaXItdG8td2F0Y2gnXSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy52YWxpZGF0ZURpcmVjdG9yeSgnZGlyLXRvLXdhdGNoJywgYXJndlsnZGlyLXRvLXdhdGNoJ10pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYXJndi5pZGVudGlmaWVyKSB7XG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyUmVnZXggPSAvXlthLXpBLVowLTktXXsxLDE1fSQvO1xuICAgICAgICAgICAgaWYgKCFhcmd2LmlkZW50aWZpZXIubWF0Y2goaWRlbnRpZmllclJlZ2V4KSkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYC0taWRlbnRpZmllciBzaG91bGQgbWF0Y2ggW2EtekEtWjAtOS1dIGFuZCBiZSBsZXNzIHRoYW4gMTUgY2hhcmFjdGVycy5gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KVxuICAgICAgICAuY29uZmxpY3RzKCdvbmNlJywgWydleGNsdWRlJywgJ2Rpci10by13YXRjaCddKVxuICAgICAgICAubWlkZGxld2FyZShbdGhpcy5jb21tYW5kTWlkZGxld2FyZS5lbnN1cmVBd3NDcmVkZW50aWFsQW5kUmVnaW9uXSlcbiAgICApO1xuICB9O1xuXG4gIHNpZ0ludEhhbmRsZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYW5zd2VyID0gYXdhaXQgQW1wbGlmeVByb21wdGVyLnllc09yTm8oe1xuICAgICAgbWVzc2FnZTpcbiAgICAgICAgJ1dvdWxkIHlvdSBsaWtlIHRvIGRlbGV0ZSBhbGwgdGhlIHJlc291cmNlcyBpbiB5b3VyIHNhbmRib3ggZW52aXJvbm1lbnQgKFRoaXMgY2Fubm90IGJlIHVuZG9uZSk/JyxcbiAgICAgIGRlZmF1bHRWYWx1ZTogZmFsc2UsXG4gICAgfSk7XG4gICAgaWYgKGFuc3dlcilcbiAgICAgIGF3YWl0IChcbiAgICAgICAgYXdhaXQgdGhpcy5zYW5kYm94RmFjdG9yeS5nZXRJbnN0YW5jZSgpXG4gICAgICApLmRlbGV0ZSh7IGlkZW50aWZpZXI6IHRoaXMuc2FuZGJveElkZW50aWZpZXIgfSk7XG4gIH07XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZURpcmVjdG9yeSA9IGFzeW5jIChvcHRpb246IHN0cmluZywgZGlyOiBzdHJpbmcpID0+IHtcbiAgICBsZXQgc3RhdHM7XG4gICAgdHJ5IHtcbiAgICAgIHN0YXRzID0gYXdhaXQgZnNwLnN0YXQoZGlyLCB7fSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAtLSR7b3B0aW9ufSAke2Rpcn0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG4gICAgaWYgKCFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBpcyBub3QgYSB2YWxpZCBkaXJlY3RvcnlgKTtcbiAgICB9XG4gIH07XG59XG4iXX0=